# Godot Story: Loot Generation & Gear Effects

**Epic:** Equipment Matrix & Progression  
**Story ID:** 3.2  
**Priority:** High  
**Points:** 8  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement loot generation tying gear drops to room/threat types and progression depth. Ensure equipped items consume dice to trigger effects (damage, conversion, resources) with cooldowns and rarities. Provide distinct visuals for rare items. References: PRD story (docs/game-prd.md:300-314) and architecture sections on EquipmentController, Resource-driven content (docs/architecture.md:120-320, 360-410).

**Godot Implementation:** Using `LootTableResource`, `EquipmentInventoryModel`, and `EquipmentController` integrations in typed GDScript to deliver rewarding gear drops  
**Performance Impact:** Medium; loot rolls should be data-driven and cached to avoid runtime overhead; activation effects must reuse pooled nodes

## Acceptance Criteria
### Functional Requirements
- [ ] Loot tables tie drops to room/threat tags and run depth (early/late tiers)
- [ ] Gear items define dice costs, effects, and cooldowns; consuming dice updates exhaust pool immediately
- [ ] Rare items introduce unique symbols/visuals distinct from commons
- [ ] Gear activation resolves instantly and updates ResourceLedger/ThreatService as appropriate

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Loot generation executes <1ms per drop (preloaded tables) and activation effects pooled

### Game Design Requirements
- [ ] Loot supports varied builds and tactical options (docs/game-prd.md:40-95, 300-314)
- [ ] Rarity visuals communicate value and support progression fantasy
- [ ] Dice consumption integrates with push-your-luck cadence

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/loot_drop_popup.tscn` - Displays drop summary and rarity flair
- `res://scenes/fx/gear_activation_vfx.tscn` - Pooled effect for gear usage

**New Scripts:**

- `res://scripts/resources/loot_table_resource.gd` - Defines drop weights per tag/depth
- `res://scripts/services/loot_service.gd` - Autoload or utility generating loot from tables
- `res://scripts/gameplay/gear_activation_system.gd` - Resolves dice costs, cooldowns, and effects
- `res://scripts/ui/loot_drop_popup_controller.gd` - Presents drop info and handles auto-add option

**New Resources (.tres):**

- `res://resources/loot/loot_table_room.tres`, `loot_table_threat.tres`
- `res://resources/equipment/module_*.tres` - updated to include rarity, cooldown, effect definitions
- `res://resources/fx/gear_activation_vfx.tres`

**Modified Files:**

- `res://scripts/autoload/room_queue_service.gd` - Spawn loot post-exploration (where applicable)
- `res://scripts/autoload/threat_service.gd` - Trigger loot on threat defeat
- `res://scripts/ui/equipment_controller.gd` - Hook activation logic and cooldown states

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# loot_service.gd
class_name LootService
extends Node

@export var room_loot_table: LootTableResource
@export var threat_loot_table: LootTableResource

func roll_loot(context: LootContext) -> Array[EquipmentModuleResource]:
    var table := context.is_threat ? threat_loot_table : room_loot_table
    return table.pick_modules(context)
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/LootPopup`
- Scene Instancing: Loot popup pooled, gear activation VFX pooled under `fx/`

**Node Dependencies:**

- `LootService` - provides drop results
- `EquipmentInventoryModel` - stores new gear
- `EquipmentController` - displays and binds items
- `TurnManager` - handles activation requests & dice spending
- `ResourceLedger`, `ThreatService` - apply effects from gear

**Signal Connections:**

- Emits: `loot_awarded`, `gear_activated`, `cooldown_updated`
- Connects to: Equipment controller, HUD, telemetry logging
- Cleanup: Cooldown timers disconnected on gear removal; VFX returned to pool

**Resource Dependencies:**

- `res://resources/loot/*.tres` - loot tables
- `res://resources/equipment/module_*.tres` - gear metadata
- `res://resources/fx/gear_activation_vfx.tres` - effect resource

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_loot_service.gd` verifying tag/depth weighting
- [ ] Create `res://tests/unit/test_gear_activation_system.gd` verifying dice cost consumption & cooldowns
- [ ] Performance test ensuring loot roll <1ms with preloaded tables

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement loot service picking modules per tables
- [ ] Implement activation system applying effects, managing cooldown timers
- [ ] Optimize data structures (precomputed arrays) to pass performance test
- [ ] Ensure tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Add static typing across loot/gear systems
- [ ] Pool VFX/audio for gear activation and loot popups
- [ ] Ensure dice consumption integrated with TurnManager/ResourceLedger
- [ ] Validate performance in profiler while spamming activations
- [ ] Maintain coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for loot service and gear activation
- [ ] Implement loot generation, gear effects, cooldowns to satisfy tests
- [ ] Refactor with typed data, pooling, telemetry integration
- [ ] Create object pool for loot popup and gear activation VFX
- [ ] Implement signal connections linking loot, equipment, TurnManager, telemetry
- [ ] Profile performance to ensure 60+ FPS when activating gear
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with room/threat rewards and equipment matrix
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - suits data-driven loot/gear logic alongside existing systems

**Node Architecture:**
```
RunHUD (Control)
└── LootPopup (CanvasLayer)
    └── LootSummary (Control)

EquipmentController (Control)
└── ActivationEffects (Node)
    └── GearActivationVFX (GPUParticles3D) [pooled]
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <150 when loot popup + VFX active

**Object Pooling Required:**
- Loot popup nodes: pool size 2
- Activation VFX/audio: pool size 4

## Game Design Context
**GDD Reference:** Epic 3, Story 3.2 (docs/game-prd.md:300-308)

**Game Mechanic:** Gear acquisition altering tactics and dice usage

**Godot Implementation Approach:**
- Node Architecture: Resource-based loot, pooled UI & VFX (docs/architecture.md:240-360)
- Language Choice: GDScript ensures integration with autoload services
- Performance Target: Keep loot rolls/gear activations under 1ms CPU

**Player Experience Goal:** Reward exploration/combat with meaningful gear, reinforcing dice economy choices.

**Balance Parameters (Resource-based):**

- Drop weights per tag stored in `loot_table_*.tres`
- Cooldown durations, dice costs exported per module resource

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_loot_service.gd`
- `res://tests/unit/test_gear_activation_system.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Loot roll respects tag weights and depth thresholds - ensures data-driven fairness
- Activation consumes dice, updates exhaust pool, enforces cooldown - signal verification
- Rare item visuals flagged for UI to differentiate - boundary testing
- Performance test: loot roll + activation effect <16.67ms total, <1ms CPU each

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Defeat threat and observe loot drop
   - Expected: Popup shows gear with rarity flair, auto-add to stash, telemetry entry created
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms during drop animation
   - Object Pools: Popup reused

2. Activate gear with dice cost during combat
   - Expected: Dice consumed, exhaust tray updates, effect plays with pooled VFX
   - Signal Flow: `gear_activated` -> `TurnManager` -> `ResourceLedger`
   - Cooldown: Gear temporarily unavailable and re-enabled after timer

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <3ms
- Memory usage: <370MB with loot assets loaded
- Draw calls: <150 with popup/VFX active
- Object pools: Popups/VFX reused without spikes
- GDScript static typing: Verified
- C# optimization: N/A
- Loot roll CPU cost: <1ms

## Dependencies
**Story Dependencies:**

- 3.1: Equipment matrix to house gear
- 2.x: Room/threat content awarding loot

**Godot System Dependencies:**

- Node: Equipment panel, loot popup placeholder
- Autoload: `LootService`, `EquipmentInventoryModel`, `TurnManager`, `ResourceLedger`, `TelemetryHub`
- Language: Typed GDScript pipeline

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: Loot tables, module definitions, activation VFX
- Location: `res://resources/loot/`, `res://resources/equipment/`, `res://resources/fx/`
- Import Settings: Text resources for gear/loot; binary for VFX if needed

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Loot telemetry validated for balancing metrics

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript leverages existing service patterns; no need for C# micro-optimization yet
- Node Architecture: Loot service decoupled for reuse by multiple systems, popup overlay matches existing UI style
- Signal Pattern: LootService emits results, EquipmentInventoryModel handles storage
- Consider synergy with remote config (Story 4.4) for balancing in future

**Performance Decisions:**

- Static Typing: Precompute arrays and typed dictionaries for drop tables
- C# Usage: Not required now; revisit if profiling indicates
- Object Pooling: Popups, VFX, and activation audio pooled
- Preload loot tables at game boot to avoid runtime loading cost
