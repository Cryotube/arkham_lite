# Godot Story: Meta Progression & Unlocks

**Epic:** Equipment Matrix & Progression  
**Story ID:** 3.4  
**Priority:** Medium  
**Points:** 8  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement the meta progression layer that records run outcomes, grants unlocks (rooms, threats, equipment), and exposes a codex with lore/stat tracking. Provide a profile-aware meta screen showing unlock dependencies plus a codex detail view. References: docs/game-prd.md:330-344 and docs/architecture.md:240-360, 400-460.

**Godot Implementation:** `MetaProgressService` autoload + `SaveService` persistence + `CodexController` UI in typed GDScript for replay incentives  
**Performance Impact:** Low-medium; evaluation happens post-run and meta screens must stay responsive on mobile

## Acceptance Criteria
### Functional Requirements
- [ ] Completing a run writes a run summary and awards unlocks defined in `unlock_tree.tres`
- [ ] Meta screen renders unlock tree with prerequisites, current status, and highlights new unlocks
- [ ] Codex lists discovered threats/rooms/equipment with lore snippets and stats; locked entries hidden
- [ ] Profile selector supports at least two local profiles with independent progress/reset

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Unlock evaluation executes <0.5ms per run; tree/codex reuse pooled nodes to avoid allocations

### Game Design Requirements
- [ ] Unlock cadence matches PRD replay goals
- [ ] Codex tone aligns with sci-fi horror theme and supports accessibility (scalable fonts)
- [ ] Profiles can be reset independently for QA/beta without touching other data

## Technical Specifications
- Scenes: `meta_progress_screen.tscn`, `codex_panel.tscn`
- Scripts: `meta_progress_service.gd`, `meta_progress_screen_controller.gd`, `codex_controller.gd`, `profile_manager.gd`
- Resources: `unlock_tree.tres`, `codex` entries
- Modified: `post_run_summary_controller.gd`, `save_service.gd`, `game_director.gd`

## TDD Workflow (Red-Green-Refactor)
- RED: tests for MetaProgressService evaluation/persistence, ProfileManager isolation, CodexController rendering
- GREEN: implement evaluation logic, profile storage, pooled UI nodes
- REFACTOR: enforce static typing, pooling, SaveService schema versioning

## Implementation Tasks
- [ ] Write unit tests (RED)
- [ ] Implement meta progression service/profile manager/codex UI (GREEN)
- [ ] Refactor for typed data, pooling, telemetry logging (REFACTOR)
- [ ] Integration testing with post-run summary and SaveService persistence
- [ ] Profile meta screen to ensure 60+ FPS and evaluation <0.5ms

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
- Engine: Godot 4.5 Forward+
- Primary language: GDScript
- Node architecture: pooled unlock/codex entries per docs/architecture.md:320-420
- Performance: 60 FPS; draw calls <140 in meta screens; memory <360MB with meta assets

## Game Design Context
- Replay incentives via unlocks/codex (PRD Epic 3 Story 3.4)

## Testing Requirements
- Unit tests + manual scenarios: grant unlocks, switch profiles, browse codex
- Performance capture via profiler when navigating meta/codex

## Dependencies
- Depends on Stories 3.2/3.3 for unlock data; integrates with Story 1.4 post-run summary

## Definition of Done
- Acceptance criteria met; tests passing; telemetry/export updated; documentation refreshed

## Notes
- Provide dev tools to grant/reset unlocks for QA
- Plan future cloud sync integration but keep stubbed behind flag
