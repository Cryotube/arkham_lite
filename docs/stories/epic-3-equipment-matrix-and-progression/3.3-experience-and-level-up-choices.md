# Godot Story: Experience & Level-Up Choices

**Epic:** Equipment Matrix & Progression  
**Story ID:** 3.3  
**Priority:** Medium  
**Points:** 8  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Create the XP system that tallies rewards from threats/objectives and offers level-up nodes with at least three upgrade options (new die, symbol modifier, passive perk). Upgrades modify the dice tray immediately and persist via saves. Provide reject option with banked XP logic. References: PRD story (docs/game-prd.md:315-329) and architecture sections covering ResourceLedger, SaveService, dice subsystem (docs/architecture.md:80-220, 320-360).

**Godot Implementation:** Using `ResourceLedger` XP extension, `LevelUpService`, and `DiceSubsystem` integration in typed GDScript to update dice pools and persistence  
**Performance Impact:** Low-medium; level-up overlays and dice modifications must avoid reloading scenes; XP calculations executed on event triggers

## Acceptance Criteria
### Functional Requirements
- [ ] XP accumulates from configured sources (threat defeats, objectives) and triggers level-up when thresholds reached
- [ ] Level-up UI presents ≥3 upgrade choices (new die, symbol modifier, passive perk)
- [ ] Selected upgrade immediately updates dice tray and persists via SaveService
- [ ] Reject option banks level for later with minor resource cost per PRD

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Level-up overlay operations execute <1ms per choice selection and reuse pooled components

### Game Design Requirements
- [ ] Upgrade options align with build diversity goals (docs/game-prd.md:40-95, 315-329)
- [ ] Dice tray updates maintain clarity and update exhaust pool appropriately
- [ ] Reject option imposes cost but preserves agency

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/level_up_overlay.tscn` - Overlay presenting upgrades and bank option
- `res://scenes/ui/upgrade_card.tscn` - Visual card for each upgrade choice

**New Scripts:**

- `res://scripts/services/level_up_service.gd` - Tracks XP thresholds, manages upgrade selection
- `res://scripts/ui/level_up_overlay_controller.gd` - Handles UI, selection logic, cost enforcement
- `res://scripts/resources/upgrade_option_resource.gd` - Describes upgrade effects
- `res://scripts/gameplay/dice_upgrade_system.gd` - Applies dice/tray changes to `DiceSubsystem`

**Modified Files:**

- `res://scripts/autoload/resource_ledger.gd` - Add XP field and signals
- `res://scripts/autoload/turn_manager.gd` - Award XP from combat/objectives
- `res://scripts/autoload/save_service.gd` - Persist XP and upgrade selections
- `res://scripts/gameplay/dice_subsystem.gd` - Support dynamic dice additions/modifiers

**New Resources (.tres):**

- `res://resources/config/level_up_curve.tres` - XP thresholds and costs
- `res://resources/upgrades/upgrade_*.tres` - Upgrade definitions for nodes

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# level_up_service.gd
class_name LevelUpService
extends Node

@export var level_up_curve: LevelUpCurveResource
var _xp: int = 0
var _pending_levels: int = 0

signal level_up_ready(options: Array[UpgradeOptionResource])
signal upgrade_selected(option: UpgradeOptionResource)

func add_xp(amount: int) -> void:
    _xp += amount
    while _xp >= level_up_curve.get_xp_for_level(current_level + _pending_levels + 1):
        _pending_levels += 1
        level_up_ready.emit(_generate_options())
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/LevelUpOverlay`
- Scene Instancing: Overlay pooled; upgrade cards instanced from pool

**Node Dependencies:**

- `LevelUpService` - new autoload hooking ResourceLedger and TurnManager events
- `DiceSubsystem` - updates dice pool when upgrade applied
- `ResourceLedger` - stores XP and handles reject cost
- `SaveService` - persists XP and applied upgrades
- `TelemetryHub` - logs upgrade choices

**Signal Connections:**

- Emits: `level_up_ready`, `upgrade_selected`, `upgrade_declined`
- Connects to: Overlay controller for UI, DiceSubsystem for updates, TelemetryHub for logging
- Cleanup: Reset pending levels on new run; overlay returns to pool

**Resource Dependencies:**

- `res://resources/config/level_up_curve.tres` - thresholds/costs (preload yes)
- `res://resources/upgrades/upgrade_catalog.tres` - available upgrades (preload yes)

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_level_up_service.gd` verifying XP accumulation and options generation
- [ ] Create `res://tests/unit/test_dice_upgrade_system.gd` verifying dice tray updates and persistence
- [ ] Performance test ensuring overlay selection <1ms CPU

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement XP tracking and level-up option generation
- [ ] Implement dice upgrade system modifying SubViewport dice resources
- [ ] Optimize overlay selection logic to satisfy performance test
- [ ] Ensure tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Add static typing across services and upgrade resources
- [ ] Pool overlay and upgrade cards
- [ ] Ensure SaveService persists upgrades and handles migrations
- [ ] Validate performance and memory under repeated upgrades
- [ ] Maintain coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for level-up service and dice upgrade system
- [ ] Implement XP accrual, upgrade UI, dice modifications to satisfy tests
- [ ] Refactor using typed structures, pooling, telemetry logging
- [ ] Create object pool for upgrade cards and overlay
- [ ] Implement signal connections among LevelUpService, DiceSubsystem, SaveService
- [ ] Profile performance to ensure 60+ FPS during overlay usage
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with threat/objective XP sources and equipment synergy
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - ensures consistent integration with existing systems

**Node Architecture:**
```
RunHUD (Control)
└── LevelUpOverlay (CanvasLayer)
    ├── UpgradeList (VBoxContainer)
    │   └── UpgradeCard (Control) [pooled]
    └── RejectButton (Button)
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <130 when overlay active

**Object Pooling Required:**
- Upgrade cards: pool size 6 (three options + buffer)
- Overlay: pool size 1 reused

## Game Design Context
**GDD Reference:** Epic 3, Story 3.3 (docs/game-prd.md:315-323)

**Game Mechanic:** XP-based progression with customizable upgrade choices

**Godot Implementation Approach:**
- Node Architecture: Autoload service driving overlay UI (docs/architecture.md:250-360)
- Language Choice: GDScript to interact with ResourceLedger, SaveService, DiceSubsystem
- Performance Target: Overlay updates minimal; maintain frame consistency

**Player Experience Goal:** Offer meaningful build-defining choices with immediate feedback and persistence.

**Balance Parameters (Resource-based):**

- XP thresholds, reject cost stored in `level_up_curve.tres`
- Upgrade effects defined in `upgrade_*.tres`

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_level_up_service.gd`
- `res://tests/unit/test_dice_upgrade_system.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- XP accumulation triggers pending levels correctly - ensures data integrity
- Selecting upgrade modifies dice tray (additional die/symbol) and persists - signal verification
- Reject option banks level and deducts cost once - boundary testing
- Performance test: overlay selection logic <1ms CPU, frame time <16.67ms

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Earn XP through threat defeat to trigger level-up
   - Expected: Overlay appears with three distinct upgrades; selection updates dice tray and saves state
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Save/Load: Reload project to confirm upgrade persisted

2. Reject upgrade to bank for later
   - Expected: XP banked, resource penalty applied, overlay closes; next trigger shows updated options
   - Signal Flow: `upgrade_declined` fired with cost details
   - Object Pools: Overlay/cards reused

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <2ms (UI heavy)
- Memory usage: <340MB with overlay assets
- Draw calls: <130 with overlay active
- Object pools: Upgrade cards reused without churn
- GDScript static typing: Verified
- C# optimization: N/A
- Upgrade application CPU cost: <1ms

## Dependencies
**Story Dependencies:**

- 3.1 & 3.2: Equipment matrix and loot integration provide gear synergy
- 2.3: Mini objectives may award XP

**Godot System Dependencies:**

- Node: Level-up overlay placeholder in RunHUD
- Autoload: `LevelUpService`, `ResourceLedger`, `SaveService`, `DiceSubsystem`, `TelemetryHub`
- Language: Typed GDScript pipeline

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: `level_up_curve.tres`, `upgrade_*.tres`
- Location: `res://resources/config/`, `res://resources/upgrades/`
- Import Settings: Text resources for diff-friendly editing

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Upgrade choices logged for telemetry analysis

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript ensures easy integration across autoload services
- Node Architecture: Overlay design consistent with other modals, supporting text scaling
- Signal Pattern: LevelUpService centralizes logic, overlay purely presentational
- Provide debug console commands to grant XP for QA testing

**Performance Decisions:**

- Static Typing: XP values ints, upgrade arrays typed to resources
- C# Usage: Not required
- Object Pooling: Overlay/cards reused, dice modifications operate on preloaded resources
- Prefetch upgrade resources to avoid runtime loads when overlay appears
