# Godot Story: Core Resources & HUD Feedback

**Epic:** Crash Survivor Foundation  
**Story ID:** 1.2  
**Priority:** High  
**Points:** 8  
**Status:** In Progress  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement the `ResourceLedger` autoload and HUD panels that display and update health, materials, oxygen, and the global threat meter whenever dice results or scripted events occur. Adds warning thresholds, audio cues, and provisional save serialization so resource state persists through scene reloads. References: resource requirements (docs/game-prd.md:155-186) and architecture sections (docs/architecture.md:160-240).

**Godot Implementation:** Using `ResourceLedger` autoload and `HUDController` Control nodes in GDScript for immediate UI binding with static typing  
**Performance Impact:** Low; HUD updates run on main thread with minimal allocations, must maintain <1ms frame cost

## Acceptance Criteria
### Functional Requirements
- [x] HUD displays four meters (health, materials, oxygen, threat) with numeric values and color-coded thresholds
- [x] Dice or scripted test events adjust resources and update HUD instantly
- [x] Threat meter triggers yellow/red visual + audio cues when crossing thresholds
- [x] Resource state persists across scene reloads using provisional save slots

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [x] `ResourceLedger` updates fire typed signals and debounce multi-update bursts to avoid UI thrash

### Game Design Requirements
- [x] Resource readouts communicate survival pressure outlined in PRD (docs/game-prd.md:40-95)
- [x] Warning cues align with UX accessibility goals (docs/game-prd.md:96-140)
- [x] Persistence behavior supports short mobile sessions without data loss

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/resource_panel.tscn` - Control scene containing meter widgets
- `res://scenes/ui/threat_meter.tscn` - Specialized Control with thresholds and animations

**New Scripts:**

- `res://scripts/autoload/resource_ledger.gd` - Autoload storing resource values, emitting update signals
- `res://scripts/ui/resource_panel_controller.gd` - Subscribes to ledger updates and animates meters
- `res://scripts/ui/threat_meter_controller.gd` - Handles threshold detection and audio cues
- `res://scripts/services/save_service_stub.gd` - Extends existing SaveService with provisional run state serialization

**New Resources (.tres):**

- `res://resources/ui/resource_meter_theme.tres` - Styles for meters per accessibility guidelines
- `res://resources/config/resource_thresholds.tres` - Defines warning levels for each resource

**Modified Files:**

- `res://scenes/core/run_hud.tscn` - Add resource panel nodes and signal hookups
- `res://scripts/autoload/game_director.gd` - Register ResourceLedger and SaveService interactions

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# resource_ledger.gd
class_name ResourceLedger
extends Node

@export var max_health: int = 8
var _health: int = max_health setget set_health

signal health_changed(current: int, max: int)

func set_health(value: int) -> void:
    var clamped_value := clamp(value, 0, max_health)
    if clamped_value == _health:
        return
    _health = clamped_value
    health_changed.emit(_health, max_health)
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/ResourcePanel`
- Scene Instancing: Resource panel instanced within RunHUD and hooked to ResourceLedger

**Node Dependencies:**

- `ResourceLedger` (autoload) - central resource authority (GDScript)
- `HUDController` - orchestrates panel updates (GDScript)
- `SaveService` - temporary run state serialization (GDScript)

**Signal Connections:**

- Emits: `health_changed`, `materials_changed`, `oxygen_changed`, `threat_changed`
- Connects to: `resource_panel_controller.gd` to update meters; warning signals to `AudioDirector`
- Cleanup: HUD panel disconnects in `_exit_tree()`, SaveService clears provisional slots on run end

**Resource Dependencies:**

- `res://resources/config/resource_thresholds.tres` - used for warning thresholds (preload yes)
- `res://resources/ui/resource_meter_theme.tres` - theme for bars (preload yes)

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [x] Create `res://tests/unit/test_resource_ledger.gd`
- [x] Write test verifying clamped updates and signal emission - expect failure
- [x] Write test ensuring persistence roundtrip via SaveService stub - expect failure
- [ ] Write performance test confirming batched updates stay <0.5ms - expect failure

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [x] Implement ledger setters, typed signals, and throttle logic
- [x] Implement SaveService provisional serialization to satisfy persistence test
- [x] Optimize update pipeline to keep performance test green
- [ ] Ensure all tests green

**REFACTOR Phase - Optimize and Clean:**

- [x] Apply static typing to all ledger and HUD scripts
- [ ] Replace Dictionary-based payloads with typed structs
- [x] Pool warning VFX/audio players
- [x] Ensure signal connections cleaned in `_exit_tree()`
- [ ] Profile HUD updates with debugger, confirm <1ms per frame
- [ ] Confirm coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [x] Write GUT tests for ResourceLedger and SaveService provisional flow
- [x] Implement ledger, panel controller, and threshold cues to pass tests
- [x] Refactor with typed properties and pooled UI elements
- [x] Create object pool for warning popups/audio players
- [x] Implement signal connections linking TurnManager test events to ledger
- [ ] Profile performance to ensure 60+ FPS
- [x] Language optimization (GDScript static typing)
- [ ] Integration testing with RunHUD interactions
- [ ] Final performance validation (must maintain 60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| Resource ledger autoload | scripts/autoload/resource_ledger.gd | Added resource tracking singleton with threshold signals and SaveService integration | No |
| Save service stub | scripts/services/save_service_stub.gd | Created in-memory run snapshot store for provisional persistence | No |
| HUD resource panel | scenes/ui/resource_panel.tscn / scripts/ui/resource_panel_controller.gd | Built HUD meters and bindings to ResourceLedger signals | No |
| Threat meter component | scenes/ui/threat_meter.tscn / scripts/ui/threat_meter_controller.gd | Implemented threat meter visuals with pooled audio cues | No |
| Turn orchestration hooks | scripts/core/game_director.gd / scripts/systems/turn_manager.gd | Wired ResourceLedger resets and roll outcome resource adjustments | No |
| GUT coverage | tests/unit/test_resource_ledger.gd / tests/unit/test_resource_panel_controller.gd | Added unit tests for ledger persistence and HUD updates | No |

**Completion Notes:**
- Resource ledger currently persists run state in-memory via SaveService stub; long-term disk persistence still required.
- Headless GUT wrapper (`./scripts/run_gut_tests.sh`) executes but unit suite still needs attention before declaring Story Ready.
- Performance profiling + integration playthrough still pending once additional systems land.

**File List:**
- scripts/autoload/resource_ledger.gd
- scripts/services/save_service_stub.gd
- scripts/resources/resource_thresholds.gd
- resources/config/resource_thresholds.tres
- resources/ui/resource_meter_theme.tres
- scenes/ui/resource_panel.tscn
- scripts/ui/resource_panel_controller.gd
- scenes/ui/threat_meter.tscn
- scripts/ui/threat_meter_controller.gd
- scenes/ui/run_hud.tscn
- scripts/ui/run_hud_controller.gd
- scripts/core/game_director.gd
- scripts/systems/turn_manager.gd
- tests/unit/test_resource_ledger.gd
- tests/unit/test_resource_panel_controller.gd
- project.godot

**Change Log:**
- [2025-??-??] Added ResourceLedger autoload, HUD panels, threat meter scenes, save stub, and initial GUT coverage to satisfy functional requirements.

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - resource manipulation and UI updates best served in same language as rest of codebase

**Node Architecture:**
```
RunHUD (Control)
└── ResourcePanel (Control)
    ├── HealthMeter (Control)
    ├── MaterialsMeter (Control)
    ├── OxygenMeter (Control)
    └── ThreatMeter (Control)
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: < 80 for HUD (static batched)

**Object Pooling Required:**
- Warning popups: Pool size 3 (one per threshold state)
- AudioStreamPlayer nodes: Pool size 2 reused for cues

## Game Design Context
**GDD Reference:** Epic 1, Story 1.2 (docs/game-prd.md:155-169)

**Game Mechanic:** Resource tracking and threat escalation feedback

**Godot Implementation Approach:**
- Node Architecture: Autoload ledger with Control-based meters (docs/architecture.md:160-216)
- Language Choice: GDScript to share typed signals across HUD and gameplay
- Performance Target: <1ms HUD update time while keeping 60 FPS budget

**Player Experience Goal:** Ensure players perceive survival pressure instantly with readable meters and accessible warning cues.

**Balance Parameters (Resource-based):**

- Warning thresholds defined per resource (e.g., 50% yellow, 25% red)
- Threat escalation increments stored in `resource_thresholds.tres`

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_resource_ledger.gd`
- `res://tests/unit/test_resource_panel_controller.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Ledger clamps values and emits signals exactly once per change - validates 60 FPS by preventing loops
- SaveService stores and restores resource snapshot - signal verification
- Threshold crossing triggers warning event only when crossing boundary - ensures pool boundary usage
- Performance test: batched updates keep frame time <16.67ms

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Adjust resources through debug buttons
   - Expected: meters animate to new values with color change and audio cue where applicable
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Language Validation: Typed signals deliver expected payload

2. Reload scene after modifying resources
   - Expected: values persist based on provisional save state
   - Signal Flow: Single emission on load
   - Memory: No leaks, ledger resets cleanly on new run
   - Object Pools: Warning popups reused

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <2ms (minimal impact)
- Memory usage: <280MB with HUD assets loaded
- Draw calls: <80 for UI
- Object pools: Active for warning cues
- GDScript static typing: Verified
- C# optimization: N/A
- HUD update cost: <1ms per update burst

## Dependencies
**Story Dependencies:**

- 1.1: Requires dice loop signals to feed resource changes

**Godot System Dependencies:**

- Node: RunHUD scene from Story 1.1
- Autoload: `ResourceLedger`, `SaveService`
- Language: Typed GDScript project-wide

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: `resource_thresholds.tres`
- Location: `res://resources/config/resource_thresholds.tres`
- Import Settings: Keep as text resource for diff-friendly edits

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Resource warnings verified on target devices for readability

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript because ledger integration benefits from single-language pipeline
- Node Architecture: Modular Control scenes keep HUD maintainable
- Signal Pattern: One autoload emits typed signals consumed by multiple panels
- Save stub should live under `scripts/services/` per architecture file structure

**Performance Decisions:**

- Static Typing: All ledger fields typed to integers/floats
- C# Usage: Deferred unless profiling shows need for IL speedups
- Object Pooling: Popups and audio players pooled to prevent GC spikes
- Animations use Tweeners reused via nodes instead of creating new tweens per update
