# Godot Story: First Threat Encounter & Escape Resolution

**Epic:** Crash Survivor Foundation  
**Story ID:** 1.4  
**Priority:** High  
**Points:** 13  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Deliver the first end-to-end threat encounter: spawn a scripted latched threat, run its attack timer, allow combat and evasion resolutions, and trigger the escape prompt once the clue threshold is met. Includes defeat/victory flows, post-run summary, and telemetry stub output. References: PRD story (docs/game-prd.md:187-214) and architecture sections covering ThreatService, CombatResolver, GameDirector state machine (docs/architecture.md:200-340).

**Godot Implementation:** Using `ThreatService` autoload, `CombatResolver` utility, and `GameDirector` state transitions in typed GDScript to orchestrate threat phases  
**Performance Impact:** Medium; timers and dice interactions must be optimized with pooling to maintain frame rate, especially when threat attacks trigger VFX

## Acceptance Criteria
### Functional Requirements
- [ ] Scripted event latches a single threat with attack timer UI and countdown behavior
- [ ] Combat resolution allows spending attack symbols to meet damage threshold; evasion requires agility symbol set
- [ ] Collecting configured clue count unlocks escape prompt; failure triggers defeat screen with summary
- [ ] Post-run summary logs resources, duration, and outputs telemetry stub entries for analytics

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Threat timers and attack animations executed via pooled timers/particles and do not allocate per tick

### Game Design Requirements
- [ ] Threat cadence matches latching behavior described in PRD (docs/game-prd.md:40-95)
- [ ] Escape conditions align with clue economy goals (docs/game-prd.md:40-70)
- [ ] Summary screen communicates key run metrics supporting validation plan

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/threat_overlay.tscn` - Control overlay showing latched threat, timer, combat/evasion options
- `res://scenes/ui/escape_prompt.tscn` - Modal presenting escape decision when clues met
- `res://scenes/ui/post_run_summary.tscn` - Summary panel with run stats and telemetry stub button

**New Scripts:**

- `res://scripts/autoload/threat_service.gd` - Manages threat lifecycle, timers, and resolution signals
- `res://scripts/gameplay/combat_resolver.gd` - Handles symbol validation, damage application, and outcomes
- `res://scripts/ui/threat_overlay_controller.gd` - Binds threat data to overlay and handles player choices
- `res://scripts/ui/escape_prompt_controller.gd` - Validates clue threshold and triggers victory state
- `res://scripts/ui/post_run_summary_controller.gd` - Aggregates run data and fires telemetry stub

**New Resources (.tres):**

- `res://resources/threats/first_latched_threat.tres` - Defines baseline threat stats, timer cadence, rewards
- `res://resources/config/escape_requirements.tres` - Configurable clue thresholds and rewards

**Modified Files:**

- `res://scripts/autoload/turn_manager.gd` - Insert threat phase calls and door into escape check
- `res://scripts/autoload/game_director.gd` - Handle state transitions to `RunCompleted`
- `res://scenes/core/run_hud.tscn` - Add threat overlay and escape prompt placeholders

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# threat_service.gd
class_name ThreatService
extends Node

@export var threat_profile: ThreatProfileResource

var _active_threat: ThreatProfileResource
var _attack_timer := 0.0

signal threat_timer_updated(time_remaining: float)
signal threat_action_resolved(outcome: String)

func spawn_threat(resource: ThreatProfileResource) -> void:
    _active_threat = resource
    _attack_timer = resource.attack_cadence_seconds
    # Emit latch signal to UI
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/ThreatOverlay`
- Scene Instancing: Threat overlay added as CanvasLayer; Post Run summary shown via `GameDirector`

**Node Dependencies:**

- `ThreatService` autoload - orchestrates timers and outcomes (GDScript)
- `CombatResolver` - utility invoked from `TurnManager`
- `GameDirector` - state machine transitions to escape/defeat scenes
- `ResourceLedger` - applies damage/resource adjustments

**Signal Connections:**

- Emits: `threat_timer_updated`, `threat_action_resolved`, `escape_unlocked`
- Connects to: `ThreatOverlayController`, `EscapePromptController`, `GameDirector`
- Cleanup: Timer signals disconnected in `_exit_tree()`, threat resources cleared post-run

**Resource Dependencies:**

- `res://resources/threats/first_latched_threat.tres` - threat definition (preload yes)
- `res://resources/config/escape_requirements.tres` - clue threshold (preload yes)

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_threat_service.gd`
- [ ] Test timer countdown and attack trigger at cadence - expect failure
- [ ] Test combat and evasion resolutions adjusting resources correctly - expect failure
- [ ] Performance test verifying threat tick logic stays <0.5ms per frame - expect failure

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement timer updates using `_process` gating and pooling
- [ ] Implement combat resolver applying damage/evasion results
- [ ] Optimize logic to maintain sub-millisecond tick cost
- [ ] Ensure tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Add static typing to threat resources and overlay controllers
- [ ] Pool VFX/audio for attacks to avoid allocations
- [ ] Cleanup signals and reset state on defeat/victory
- [ ] Validate performance with profiler including timer spikes
- [ ] Achieve coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for ThreatService timers/combat
- [ ] Implement threat spawn, timer, overlays, escape logic to satisfy tests
- [ ] Refactor with typed structs, pooling, and state cleanup
- [ ] Create object pool for threat attack VFX/audio cues
- [ ] Implement signal connections among TurnManager, ThreatService, GameDirector
- [ ] Profile performance to ensure 60+ FPS even during threat actions
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with ResourceLedger, RoomQueueService, telemetry stub
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - threat systems integrate with existing autoload architecture

**Node Architecture:**
```
RunHUD (Control)
└── ThreatOverlay (CanvasLayer)
    ├── ThreatCard (Control)
    ├── TimerDisplay (Label)
    ├── CombatButtons (Control)
    └── EvasionButtons (Control)
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <110 when overlay active

**Object Pooling Required:**
- Threat attack VFX/audio emitters: pool size 3
- Timer tick indicators: pool size 2 for reuse

## Game Design Context
**GDD Reference:** Epic 1, Story 1.4 (docs/game-prd.md:187-214)

**Game Mechanic:** Latched threat resolution and escape sequence

**Godot Implementation Approach:**
- Node Architecture: Autoload-driven threat service with overlay UI (docs/architecture.md:210-320)
- Language Choice: GDScript ensures consistent integration with ResourceLedger and TurnManager
- Performance Target: Timer updates and attack actions must stay under 1ms to avoid frame drops

**Player Experience Goal:** Provide tense threat countdowns, clear resolution options, and satisfying run wrap-up.

**Balance Parameters (Resource-based):**

- Threat attack cadence and damage defined in `first_latched_threat.tres`
- Clue threshold for escape stored in `escape_requirements.tres`

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_threat_service.gd`
- `res://tests/unit/test_combat_resolver.gd`
- `res://tests/unit/test_escape_prompt_controller.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Timer counts down and emits attack event at defined cadence - ensures 60 FPS by gating processing
- Combat resolution reduces threat HP and updates resource ledger - signal verification
- Escape unlock fires once clue threshold reached and not before - boundary testing
- Performance test: threat tick + overlay update <16.67ms frame budget

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Trigger threat encounter through scripted event
   - Expected: Threat overlay appears, timer counts down, attack resolves on expiry
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Memory: VFX pooled, no leaks

2. Achieve escape threshold then choose escape
   - Expected: Escape prompt appears, success leads to summary screen with correct stats
   - Signal Flow: `escape_unlocked` fires once, summary collects run metrics
   - Object Pools: Attack VFX reused without re-instantiation

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average (spikes <4ms per architecture requirement)
- Physics frame: <3ms during threat dice rolls
- Memory usage: <320MB with overlay assets
- Draw calls: <110 during threat overlay
- Object pools: Attack/evasion effects reused
- GDScript static typing: Verified
- C# optimization: N/A
- Threat tick CPU cost: <0.8ms

## Dependencies
**Story Dependencies:**

- 1.1: Requires dice loop for threat resolution actions
- 1.2: ResourceLedger updates from damage/escape
- 1.3: Clue acquisition from rooms to unlock escape

**Godot System Dependencies:**

- Node: Threat overlay CanvasLayer within RunHUD
- Autoload: `ThreatService`, `TurnManager`, `GameDirector`, `TelemetryHub`
- Language: Typed GDScript baseline

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: `first_latched_threat.tres`, `escape_requirements.tres`
- Location: `res://resources/threats/`, `res://resources/config/`
- Import Settings: Text resources

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Telemetry stub outputs validated for analytics integration

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript ensures consistent integration with autoload services
- Node Architecture: Overlay + autoload separation supports future threat variants
- Signal Pattern: ThreatService centralizes emissions, GameDirector listens for state transitions
- Escape prompt should reuse UI theme assets for consistency across flows

**Performance Decisions:**

- Static Typing: All timer values floats, resources typed to `ThreatProfileResource`
- C# Usage: Deferred; potential migration if profiling shows GDScript bottlenecks
- Object Pooling: Attack/evasion VFX, audio, and timer tick markers pooled
- Threat timers use `SceneTreeTimer` pooling or manual `_process` gating to maintain budget
