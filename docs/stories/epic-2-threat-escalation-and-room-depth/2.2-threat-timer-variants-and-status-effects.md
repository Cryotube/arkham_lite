# Godot Story: Threat Timer Variants & Status Effects

**Epic:** Threat Escalation & Room Depth  
**Story ID:** 2.2  
**Priority:** High  
**Points:** 10  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Extend the threat system to support varied attack cadences (immediate, per turn, delayed burst) and status effects (bleed, oxygen leak, dice lock) with HUD indicators and durations. Update the global threat meter to react to unresolved threats each cycle and log threat actions. References: PRD story (docs/game-prd.md:234-249) and architecture sections covering ThreatService, status resources, HUD integration (docs/architecture.md:200-320).

**Godot Implementation:** Using `ThreatService` enhancements, `StatusEffectResource`, and HUD badge components in typed GDScript to convey threat pressure and statuses  
**Performance Impact:** Moderate; additional timers/status updates must remain lightweight, and UI badges should be pooled to prevent allocations

## Acceptance Criteria
### Functional Requirements
- [ ] Threat cards define attack cadence variants (immediate, per turn, delayed burst) that execute correctly
- [ ] Threat dice can apply status effects (bleed, oxygen leak, dice lock) with UI icons and duration countdowns
- [ ] Global threat meter increments when threats remain unresolved through a full cycle
- [ ] Combat log records threat actions, including status applications and resource impacts

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Status update loop runs in under 1ms and reuses pooled HUD badges/particles

### Game Design Requirements
- [ ] Threat behaviors match escalating pressure goals (docs/game-prd.md:40-95, 234-249)
- [ ] Status effects communicate consequences clearly and impact tactics
- [ ] Combat log entries provide useful telemetry for balancing

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/status_badge.tscn` - Badge displayed on HUD for active statuses

**New Scripts:**

- `res://scripts/resources/status_effect_resource.gd` - Resource defining status metadata (icon, duration, effects)
- `res://scripts/gameplay/status_effect_controller.gd` - Manages applying/removing statuses on player state
- `res://scripts/ui/status_badge_controller.gd` - Handles badge visuals, duration countdown
- `res://scripts/services/combat_log_service.gd` - Captures threat action entries (if not already created)

**New Resources (.tres):**

- `res://resources/status_effects/bleed.tres`, `oxygen_leak.tres`, `dice_lock.tres`
- Threat profiles updated to reference new cadence and status data

**Modified Files:**

- `res://scripts/autoload/threat_service.gd` - Extend to handle cadence variants and status application
- `res://scripts/ui/threat_overlay_controller.gd` - Display status icons and timers
- `res://scripts/autoload/resource_ledger.gd` - Add methods to process status ticks (oxygen drain, etc.)
- `res://resources/threats/*.tres` - Add cadence/status definitions

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# status_effect_controller.gd
class_name StatusEffectController
extends Node

var _active_effects: Array[StatusEffectResource] = []

signal status_applied(effect: StatusEffectResource)
signal status_removed(effect: StatusEffectResource)

func apply(effect: StatusEffectResource) -> void:
    _active_effects.append(effect)
    status_applied.emit(effect)

func tick(delta: float) -> void:
    for effect in _active_effects:
        effect.remaining_time -= delta
        if effect.remaining_time <= 0:
            remove(effect)
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/StatusBadgePanel`
- Scene Instancing: Status badges instanced via pool when statuses applied

**Node Dependencies:**

- `ThreatService` - emits status application and cadence events
- `StatusEffectController` - manages active status list and ticks
- `ResourceLedger` - applies effects (bleed damage, oxygen drain)
- `TelemetryHub` - logs combat log entries

**Signal Connections:**

- Emits: `status_applied`, `status_removed`, `status_tick`
- Connects to: `StatusBadgeController` for visuals, `ResourceLedger` for effect processing, `TelemetryHub` for logs
- Cleanup: Status controller clears effects on run end, badges returned to pool

**Resource Dependencies:**

- `res://resources/status_effects/*.tres` - status definitions
- `res://resources/threats/*.tres` - updated threat profiles referencing new cadences/statuses

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_threat_cadence.gd` verifying each cadence triggers correctly
- [ ] Create `res://tests/unit/test_status_effect_controller.gd` verifying apply/tick/remove flows
- [ ] Performance test ensuring status tick loop stays <1ms for typical counts

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement cadence handling within ThreatService
- [ ] Implement status controller integration with ResourceLedger and HUD
- [ ] Optimize tick logic (typed arrays, early exit) to satisfy performance test
- [ ] Confirm tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Apply static typing to status arrays and timers
- [ ] Pool badge UI nodes, VFX, and audio cues
- [ ] Ensure threat log batching avoids per-frame string allocations
- [ ] Validate performance using profiler during high-pressure sequences
- [ ] Maintain >=80% coverage

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for threat cadences and status effects
- [ ] Implement cadence logic, status controller, HUD badges to satisfy tests
- [ ] Refactor for typed arrays, pooling, efficient logging
- [ ] Create object pool for status badge nodes and effect VFX
- [ ] Implement signal connections linking ThreatService, ResourceLedger, HUD, telemetry
- [ ] Profile performance (threat ticks/status updates) to ensure 60 FPS
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with existing threat overlay and resource systems
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - consistent with threat systems and HUD integrations

**Node Architecture:**
```
RunHUD (Control)
├── ThreatOverlay (CanvasLayer)
└── StatusBadgePanel (HBoxContainer)
    └── StatusBadge (Control) [pooled]
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <120 when multiple badges active

**Object Pooling Required:**
- Status badges: pool size 5
- Status VFX/audio: pool size 3

## Game Design Context
**GDD Reference:** Epic 2, Story 2.2 (docs/game-prd.md:234-243)

**Game Mechanic:** Threat cadence variety and debuff pressure

**Godot Implementation Approach:**
- Node Architecture: Autoload threat service with pooled HUD badges (docs/architecture.md:210-330)
- Language Choice: GDScript ensures interplay with ResourceLedger and UI
- Performance Target: Keep status tick below 1ms; maintain 60 FPS even with multiple statuses

**Player Experience Goal:** Increase tension through timed attacks and ongoing debuffs while keeping feedback immediate and readable.

**Balance Parameters (Resource-based):**

- Status durations and magnitudes stored in `.tres`
- Global threat increment per unresolved threat defined in config resources

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_threat_cadence.gd`
- `res://tests/unit/test_status_effect_controller.gd`
- `res://tests/unit/test_status_badge_controller.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Immediate cadence triggers attack once on spawn - ensures timer logic accuracy
- Per-turn cadence triggers after each player action - signal verification
- Status durations tick down correctly and remove badge when expired - boundary testing
- Performance test: combined status + threat tick loop <16.67ms per frame

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Spawn threats with different cadences
   - Expected: Immediate attack resolves on spawn; per-turn triggers after each dice commit; delayed burst counts down and strikes at zero
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Logs: Combat log entries captured per attack

2. Apply multiple status effects
   - Expected: Badges appear with duration countdown; bleed drains health each tick; oxygen leak reduces oxygen meter; dice lock prevents locking when active
   - Signal Flow: Status apply/remove signals fired appropriately
   - Object Pools: Badges reused, no duplicate nodes left behind

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <3ms during threat actions
- Memory usage: <330MB with status assets
- Draw calls: <120 when overlay + badges active
- Object pools: Status badges/VFX reused
- GDScript static typing: Verified
- C# optimization: N/A
- Status tick CPU cost: <0.9ms

## Dependencies
**Story Dependencies:**

- 1.4: Builds on initial threat system
- 2.1: Event outcomes may apply statuses

**Godot System Dependencies:**

- Node: Threat overlay and status badge panel
- Autoload: `ThreatService`, `StatusEffectController`, `ResourceLedger`, `TelemetryHub`
- Language: Typed GDScript pipeline

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: Status effect resources, updated threat profiles
- Location: `res://resources/status_effects/`, `res://resources/threats/`
- Import Settings: Text resources for version control

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Threat log integrated with telemetry for balancing

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript suits timer/status logic adjacent to existing systems
- Node Architecture: Status badges separated for reuse and readability
- Signal Pattern: ThreatService central emitter, status controller handles specifics
- Cadence definitions should remain data-driven for future tuning

**Performance Decisions:**

- Static Typing: Arrays typed to `StatusEffectResource`
- C# Usage: Not needed presently
- Object Pooling: Badges and VFX audio reused to avoid allocations
- Threat log uses ring buffer to prevent unbounded growth during runs
