# Godot Story: Push-Your-Luck Time Mechanics

**Epic:** Threat Escalation & Room Depth  
**Story ID:** 2.4  
**Priority:** Medium  
**Points:** 8  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Implement new time-management actions allowing players to discard top room cards for a time/oxygen cost, scout upcoming rooms with partial info, and visualize action costs. Telemetry must capture time spent cycling vs accepting rooms. References: PRD story (docs/game-prd.md:266-283) and architecture TurnManager/time economics sections (docs/architecture.md:110-230).

**Godot Implementation:** Using `TurnManager` action economy extensions, `RoomQueueService` integrations, and HUD `ActionChip` components in typed GDScript to manage push-your-luck options  
**Performance Impact:** Low; actions should rely on existing systems with minor UI updates, ensuring operations remain under 1ms per use

## Acceptance Criteria
### Functional Requirements
- [ ] New action consumes oxygen/time to discard current top room and draw replacement, respecting deck rules
- [ ] Scouting action reveals upcoming room metadata (tag, difficulty) without consuming draw and applies temporary modifier
- [ ] HUD clearly communicates action costs and prevents resource underflow
- [ ] Telemetry records counts and time spent on cycle/scout actions for balancing

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Action economy updates leverage pooling for UI chips and run in <0.8ms per action

### Game Design Requirements
- [ ] Time management options reinforce push-your-luck decisions (docs/game-prd.md:40-95, 266-283)
- [ ] Costs balanced to avoid trivializing tension while offering agency
- [ ] Telemetry supports validation of player usage patterns

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/ui/action_chip.tscn` - Visual representation of action buttons with cost indicators

**New Scripts:**

- `res://scripts/ui/action_chip_controller.gd` - Displays cost, handles availability logic, triggers TurnManager actions
- `res://scripts/autoload/time_economy_service.gd` - Tracks available time/oxygen actions per turn (optional helper)
- `res://scripts/services/telemetry_actions_logger.gd` - Records action usage into telemetry stub

**Modified Files:**

- `res://scripts/autoload/turn_manager.gd` - Add discard/scout actions and resource checks
- `res://scripts/autoload/room_queue_service.gd` - Implement discard and scout operations
- `res://scenes/ui/room_queue_panel.tscn` - Display new action chips and reveal preview slot
- `res://scripts/autoload/resource_ledger.gd` - Provide cost deduction helpers

**New Resources (.tres):**

- `res://resources/config/time_mechanics.tres` - Configurable costs and modifiers for actions

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# turn_manager.gd (excerpt)
func discard_top_room() -> void:
    if not _can_pay_cost(time_mechanics_config.discard_cost):
        return
    resource_ledger.apply_time_cost(time_mechanics_config.discard_cost)
    room_queue_service.discard_top_room()
    telemetry_actions_logger.log_discard()
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/RoomQueuePanel/ActionChips`
- Scene Instancing: Action chips pooled and reused based on availability

**Node Dependencies:**

- `TurnManager` - orchestrates action availability and cost payment
- `RoomQueueService` - performs discard/scout operations
- `ResourceLedger` - applies oxygen/time costs
- `TelemetryHub` - receives action metrics

**Signal Connections:**

- Emits: `action_performed(action_id)`, `scout_preview_ready(room_data)`
- Connects to: HUD chips for enabling/disabling, telemetry logger for data capture
- Cleanup: Chips disconnect in `_exit_tree()`

**Resource Dependencies:**

- `res://resources/config/time_mechanics.tres` - cost configuration (preload yes)
- `res://resources/rooms/*` - used for scouting preview data

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_turn_manager_time_actions.gd` verifying cost gating and actions
- [ ] Create `res://tests/unit/test_room_queue_scout.gd` verifying preview data
- [ ] Performance test ensuring discard/scout operations <0.8ms

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement cost checks and action methods in TurnManager/RoomQueueService
- [ ] Implement scouting preview data and temporary modifiers
- [ ] Optimize for minimal allocations to pass performance test
- [ ] Confirm tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Add static typing to action config structures
- [ ] Pool action chip UI nodes and preview overlays
- [ ] Batching telemetry submissions to avoid per-action network queues (stubbed)
- [ ] Validate performance via profiler while spamming actions
- [ ] Maintain coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for discard/scout logic and preview data
- [ ] Implement TurnManager cost gating, RoomQueueService actions, HUD chips to satisfy tests
- [ ] Refactor to typed config, pooling, telemetry batching
- [ ] Create object pool for action chips and preview overlays
- [ ] Implement signal connections linking actions to telemetry and HUD state
- [ ] Profile performance (action usage) to ensure 60 FPS
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with ResourceLedger and threat escalation
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - aligns with existing TurnManager and HUD components

**Node Architecture:**
```
RoomQueuePanel (Control)
├── ActionChips (HBoxContainer)
│   ├── DiscardChip (Control) [pooled]
│   └── ScoutChip (Control) [pooled]
└── ScoutPreview (Control)
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <100 for room panel with chips

**Object Pooling Required:**
- Action chips: pool size 2 per action type
- Preview overlays: pool size 1 (reused)

## Game Design Context
**GDD Reference:** Epic 2, Story 2.4 (docs/game-prd.md:266-276)

**Game Mechanic:** Time/oxygen-based push-your-luck actions for room cycling and scouting

**Godot Implementation Approach:**
- Node Architecture: TurnManager gating actions, RoomQueueService performing operations (docs/architecture.md:110-230)
- Language Choice: GDScript ensures straightforward integration with existing services
- Performance Target: Minimal overhead for action usage; maintain frame stability

**Player Experience Goal:** Provide agency over room options while preserving tension through visible costs and limited usage.

**Balance Parameters (Resource-based):**

- Costs and modifiers defined in `time_mechanics.tres`
- Telemetry thresholds stored for analytics review

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_turn_manager_time_actions.gd`
- `res://tests/unit/test_room_queue_scout.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Discard action blocked when insufficient oxygen/time - ensures proper gating
- Scout preview reveals metadata without consuming card - signal verification
- Action telemetry increments counters correctly - boundary testing
- Performance test: discard + scout operations <0.8ms per invocation

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Use discard action repeatedly until oxygen low
   - Expected: Costs deducted, action disabled when insufficient resources, deck draws replacements respecting rules
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Telemetry: Entries counted via debug overlay/log

2. Use scout action to peek upcoming room
   - Expected: Preview displays limited info; temporary modifier applied when drawing scouted room
   - Signal Flow: `scout_preview_ready` fired with correct data
   - Object Pools: Action chips reused without instantiating new nodes

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <2ms
- Memory usage: <320MB with additional UI assets
- Draw calls: <100 while chips visible
- Object pools: Chips/preview reused
- GDScript static typing: Verified
- C# optimization: N/A
- Action execution CPU cost: <0.8ms

## Dependencies
**Story Dependencies:**

- 1.3: Base room queue implementation
- 2.1: Expanded deck content for cycling/scouting

**Godot System Dependencies:**

- Node: Room queue panel with action area placeholder
- Autoload: `TurnManager`, `RoomQueueService`, `ResourceLedger`, `TelemetryHub`
- Language: Typed GDScript environment

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: `time_mechanics.tres`
- Location: `res://resources/config/time_mechanics.tres`
- Import Settings: Text resource for version control

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Telemetry validated for action usage capture

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript consistent with existing autoloads and UI controllers
- Node Architecture: Action chips as reusable Controls keep HUD lightweight
- Signal Pattern: TurnManager centralizes action signals, TelemetryHub logs usage
- Provide debug affordance to tweak costs quickly during balancing sessions

**Performance Decisions:**

- Static Typing: Config parsed into typed structs for quick access
- C# Usage: Not needed at current complexity
- Object Pooling: Action chips and preview overlays reused to prevent GC spikes
- Evaluate using `process_mode` toggles to disable chips when overlay hidden for extra savings
