# Godot Story: Clue Milestones & Mini Objectives

**Epic:** Threat Escalation & Room Depth  
**Story ID:** 2.3  
**Priority:** Medium  
**Points:** 8  
**Status:** Approved  
**Language:** GDScript  
**Performance Target:** 60+ FPS

## Description
Introduce milestone events triggered when the player collects specific clue counts. Each milestone spawns a mini objective scene with optional challenges that yield rewards or penalties, affecting threat and resources. Escape now requires both clue threshold and final objective completion. References: PRD story (docs/game-prd.md:250-265) and architecture sections covering TurnManager, GameDirector, mini objectives (docs/architecture.md:220-320).

**Godot Implementation:** Using `TurnManager` milestone tracking, `GameDirector` state hooks, and reusable mini objective scenes in typed GDScript to deliver optional challenges  
**Performance Impact:** Low-medium; milestone checks occur at clue updates and should be constant time; mini objective scenes must recycle assets to avoid load spikes

## Acceptance Criteria
### Functional Requirements
- [ ] Clue counter triggers milestone events at configurable thresholds (e.g., 3 and 6 clues)
- [ ] Mini objective scene presents optional challenge with success/failure outcomes influencing resources/threat
- [ ] Failure consequences escalate threat or drain oxygen per configuration
- [ ] Victory sequence requires final objective completion plus clue threshold

### Technical Requirements
- Code follows GDScript/C# best practices with static typing
- Maintains 60+ FPS on all target devices (frame time <16.67ms)
- Object pooling implemented for spawned entities
- Signals properly connected and cleaned up
- GUT/GoDotTest coverage >= 80%
- [ ] Milestone evaluation executes in O(1) per clue update and uses pooled objective scenes

### Game Design Requirements
- [ ] Milestone beats reinforce progress narrative and tension (docs/game-prd.md:40-95, 250-265)
- [ ] Optional challenges feel rewarding yet risky, aligning with push-your-luck theme
- [ ] Failure penalties meaningful but not run-ending without player agency

## Technical Specifications
### Files to Create/Modify
**New Scenes (.tscn):**

- `res://scenes/gameplay/mini_objective.tscn` - Generic mini objective scene with description, challenge buttons
- `res://scenes/ui/mini_objective_overlay.tscn` - Overlay presenting objective with timer (if applicable)

**New Scripts:**

- `res://scripts/autoload/milestone_service.gd` - Tracks clue thresholds and triggers objectives
- `res://scripts/gameplay/mini_objective_controller.gd` - Handles challenge logic, integrates with ResourceLedger/ThreatService
- `res://scripts/ui/mini_objective_overlay_controller.gd` - Binds UI to objective data

**New Resources (.tres):**

- `res://resources/config/milestones.tres` - Defines clue thresholds, objective scenes, rewards/penalties
- `res://resources/objectives/objective_*.tres` - Objective parameter sets (requirements, rewards)

**Modified Files:**

- `res://scripts/autoload/turn_manager.gd` - Fire milestone checks post-clue gain
- `res://scripts/autoload/game_director.gd` - Manage overlay display and final victory gating
- `res://scripts/autoload/resource_ledger.gd` - Provide API for milestone adjustments

### Node/Class Definitions
**GDScript Implementation (for game logic):**
```gdscript
# milestone_service.gd
class_name MilestoneService
extends Node

@export var milestones: Array[MilestoneConfig] = []
var _completed: Dictionary = {}

signal milestone_triggered(config: MilestoneConfig)

func on_clues_updated(total_clues: int) -> void:
    for config in milestones:
        if total_clues >= config.clue_threshold and not _completed.get(config.id, false):
            _completed[config.id] = true
            milestone_triggered.emit(config)
```

### Integration Points
**Scene Tree Integration:**

- Parent Scene: `res://scenes/core/run_hud.tscn`
- Node Path: `/root/GameRoot/RunHUD/MiniObjectiveOverlay`
- Scene Instancing: Overlay instanced/pool-managed when milestone triggered

**Node Dependencies:**

- `MilestoneService` - new autoload listening for clue updates
- `TurnManager` - updates clue count and triggers service
- `GameDirector` - presents overlay and handles optional/mandatory flow
- `ResourceLedger`, `ThreatService` - adjust resources based on outcomes

**Signal Connections:**

- Emits: `milestone_triggered`, `objective_completed`
- Connects to: `GameDirector` for overlay, `ResourceLedger` for effects, `ThreatService` for threat adjustments
- Cleanup: Service resets on new run; overlay returns to pool on close

**Resource Dependencies:**

- `res://resources/config/milestones.tres` - configuration (preload yes)
- `res://resources/objectives/*` - objective definitions

## TDD Workflow (Red-Green-Refactor)
**RED Phase - Write Failing Tests First:**

GDScript (GUT):
- [ ] Create `res://tests/unit/test_milestone_service.gd` verifying thresholds trigger once
- [ ] Create `res://tests/unit/test_mini_objective_controller.gd` verifying success/failure outcomes
- [ ] Performance test ensuring milestone check remains constant time

C# (GoDotTest):
- Not required

**GREEN Phase - Make Tests Pass:**

- [ ] Implement milestone tracking logic and objective invocation
- [ ] Implement objective controllers applying resource/threat effects
- [ ] Optimize evaluation path to satisfy performance test
- [ ] Confirm tests pass

**REFACTOR Phase - Optimize and Clean:**

- [ ] Add static typing to milestone structures
- [ ] Pool overlay scenes to reuse UI components
- [ ] Ensure objective results logged via telemetry stub
- [ ] Validate performance with profiler after repeated triggers
- [ ] Maintain coverage >=80%

## Implementation Tasks
**TDD Tasks (Red-Green-Refactor):**

- [ ] Write GUT tests for milestones/objectives
- [ ] Implement service, overlay, and outcome handling to satisfy tests
- [ ] Refactor with typed data, pooling, telemetry logging
- [ ] Create object pool for mini objective overlay
- [ ] Implement signal connections between TurnManager, MilestoneService, GameDirector, ResourceLedger
- [ ] Profile performance (milestone check/overlay) to ensure 60 FPS
- [ ] Language optimization (GDScript static typing)
- [ ] Integration testing with clue acquisition and escape gating
- [ ] Final performance validation (60+ FPS)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
| | | | |

**Completion Notes:**

**Change Log:**

## Godot Technical Context
**Engine Version:** Godot 4.5  
**Renderer:** Forward+  
**Primary Language:** GDScript - milestone logic integrates with existing autoload systems

**Node Architecture:**
```
RunHUD (Control)
└── MiniObjectiveOverlay (CanvasLayer)
    └── MiniObjective (Control)
```

**Performance Requirements:**
- Target FPS: 60+
- Frame Budget: 16.67ms
- Memory Budget: 450MB
- Draw Calls: <115 when overlay active

**Object Pooling Required:**
- Mini objective overlay: pool size 2
- Challenge buttons and VFX: pool size 4

## Game Design Context
**GDD Reference:** Epic 2, Story 2.3 (docs/game-prd.md:250-261)

**Game Mechanic:** Clue progression milestones introducing optional challenges

**Godot Implementation Approach:**
- Node Architecture: Autoload service driving overlays (docs/architecture.md:220-310)
- Language Choice: GDScript ensures consistent integration with TurnManager/ResourceLedger
- Performance Target: Milestone evaluation constant time; overlays preloaded to avoid frame drops

**Player Experience Goal:** Reinforce progress while offering high-stakes branching choices that affect the run.

**Balance Parameters (Resource-based):**

- Thresholds, rewards, penalties stored in `milestones.tres`
- Objective timers/difficulty values stored per objective resource

## Testing Requirements
### Unit Tests (TDD Mandatory)
**GUT Test Files (GDScript):**

- `res://tests/unit/test_milestone_service.gd`
- `res://tests/unit/test_mini_objective_controller.gd`
- Coverage Target: 80%

**GoDotTest Files (C#):**

- N/A

**Test Scenarios (Write First - Red Phase):**

- Milestone triggers only once per threshold and persists across reloads - ensures constant-time evaluation
- Successful objective applies defined rewards and logs completion - signal verification
- Failed objective applies penalties correctly and escalates threat - boundary testing
- Performance test: milestone check + overlay spawn <1ms when triggered

### Game Testing
**Manual Test Cases (Godot Editor):**

1. Collect clues to hit multiple thresholds
   - Expected: Milestones trigger overlays; once completed, no duplicate triggers
   - Performance: 60+ FPS maintained
   - Profiler: Frame time <16.67ms
   - Telemetry: Entries recorded for completion/failure

2. Fail optional objective intentionally
   - Expected: Penalty applied (threat spike/oxygen drain), overlay closes, run continues
   - Signal Flow: `objective_completed` fired with failure flag
   - Object Pools: Overlay reused without leaks

### Performance Tests
**Godot Profiler Metrics (Mandatory):**

- Frame rate: 60+
- Frame time: <16.67ms average
- Physics frame: <2.5ms
- Memory usage: <335MB with overlays
- Draw calls: <115 when overlay active
- Object pools: Overlay/components reused
- GDScript static typing: Verified
- C# optimization: N/A
- Milestone check CPU cost: <0.2ms per clue update

## Dependencies
**Story Dependencies:**

- 1.4: Escape prompt base implementation
- 2.1: Additional room content awarding clues

**Godot System Dependencies:**

- Node: RunHUD overlay placeholder
- Autoload: `TurnManager`, `MilestoneService`, `GameDirector`, `ResourceLedger`, `TelemetryHub`
- Language: Typed GDScript pipeline

**Resource Dependencies:**

- Resource Type: `.tres`
- Asset: `milestones.tres`, `objective_*.tres`
- Location: `res://resources/config/`, `res://resources/objectives/`
- Import Settings: Text resources for diffs

## Definition of Done
- All acceptance criteria met
- TDD followed (tests written first, then implementation)
- GUT tests passing (GDScript) with 80%+ coverage
- GoDotTest passing (C#) with 80%+ coverage (N/A)
- Performance: 60+ FPS maintained on all platforms
- Static typing used in all GDScript
- C# optimized (no LINQ in hot paths) (N/A)
- Object pooling active for spawned entities
- Signals properly connected and cleaned up
- No GDScript or C# errors/warnings
- Node hierarchy follows architecture
- Resources (.tres) configured properly
- Export templates tested
- Documentation updated
- Milestone events documented for balancing reference

## Notes
**Godot Implementation Notes:**

- Language Choice: GDScript suits milestone logic integrated with TurnManager
- Node Architecture: Overlay reuse maintains UX consistency
- Signal Pattern: MilestoneService isolates logic, GameDirector handles presentation
- Consider replicating milestone data into debug overlay for QA verification

**Performance Decisions:**

- Static Typing: Milestone arrays typed for quick lookup
- C# Usage: Not necessary
- Object Pooling: Mini objective overlays and components reused
- Preload objective assets at run start to avoid mid-run loading stutter
